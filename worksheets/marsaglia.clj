;; gorilla-repl.fileformat = 1

;; **
;;; # Marsaglia
;;; 
;;; In probabilistic programming systems like Anglican that support _continuous_ variables, recursion, and branching on nondeterminism, it is possible to write procedures in the language itself that sample from distributions with uncountable support.  Another way of saying this is that we can denote constructive definitions of distribution over uncountable support and sample from the same.
;; **

;; @@
(ns marsaglia
  (:require [gorilla-plot.core :as plot])
  (:use clojure.repl
        [anglican core runtime emit]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; We can generate from a normal distribution in a number of ways.  A canonical method is to use the Marsaglia algorithm.
;; **

;; @@
(defn marsaglia-normal [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample* d)
        y (sample* d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal mean var))))
     
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal</span>","value":"#'marsaglia/marsaglia-normal"}
;; <=

;; **
;;; We can check that this generator produces a sample distribution that is in accordance with our understanding of the normal distribution, noting that a huge part of our understanding of the normal distribution is that we know how to compute the (log) density of a return value from from the marsaglia-normal procedure.
;; **

;; @@
(defn linspace [min max n]
   (let [step (/ (- max min) (dec n))] 
      (range min (+ max step) step)))

(def pi java.lang.Math/PI)
(defn normal-lnpdf
  "Log probability density of a sample x drawn from a univariate normal with
  known mean and standard deviation"
  [x mean std]
  (let [dx (- x mean)
        var (* std std)]
    (* -0.5
       (+ (log (* 2 (* pi var)))
          (/ (* dx dx) var)))))


(plot/compose  
  (plot/list-plot 
     (->> (linspace -5 10 100)
          (map #(into []  
                      [% (exp (normal-lnpdf % 2 2))]))
          (into [])) :joined true)
  
  (plot/histogram 
    (repeatedly 10000 
       (partial marsaglia-normal 2 4)) 
       :normalise :probability-density :bins 100))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"d956205f-0197-4b28-a69b-51d094bfbc75","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"d956205f-0197-4b28-a69b-51d094bfbc75","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"data":[{"name":"d956205f-0197-4b28-a69b-51d094bfbc75","values":[{"x":-5,"y":4.3634134752288024E-4},{"x":-4.848484848484848,"y":5.671970386513821E-4},{"x":-4.696969696969697,"y":7.330760541955561E-4},{"x":-4.545454545454545,"y":9.42044905076907E-4},{"x":-4.393939393939394,"y":0.0012036540160990396},{"x":-4.242424242424242,"y":0.0015291117517670808},{"x":-4.090909090909091,"y":0.001931453582514972},{"x":-3.939393939393939,"y":0.0024256984882430987},{"x":-3.787878787878788,"y":0.0030289831142058456},{"x":-3.636363636363636,"y":0.0037606626743546595},{"x":-3.484848484848485,"y":0.004642366243399356},{"x":-3.333333333333333,"y":0.0056979930118987235},{"x":-3.181818181818182,"y":0.0069536354318799525},{"x":-3.03030303030303,"y":0.008437415093311126},{"x":-2.878787878787879,"y":0.010179217781743341},{"x":-2.727272727272727,"y":0.01221031560013476},{"x":-2.575757575757576,"y":0.014562866395343413},{"x":-2.424242424242424,"y":0.01726928407836528},{"x":-2.272727272727273,"y":0.02036147778541647},{"x":-2.121212121212121,"y":0.023869963153426765},{"x":-1.96969696969697,"y":0.02782285516898323},{"x":-1.818181818181818,"y":0.032244758910466395},{"x":-1.666666666666667,"y":0.03715558177949653},{"x":-1.515151515151515,"y":0.04256929817839459},{"x":-1.363636363636364,"y":0.04849270464169628},{"x":-1.212121212121212,"y":0.05492420973253507},{"x":-1.060606060606061,"y":0.06185270810597594},{"x":-0.9090909090909091,"y":0.06925659156197403},{"x":-0.7575757575757576,"y":0.07710295123647007},{"x":-0.6060606060606061,"y":0.08534702395452404},{"x":-0.4545454545454545,"y":0.09393193193992498},{"x":-0.303030303030303,"y":0.10278875841821113},{"x":-0.1515151515151515,"y":0.11183699219670964},{"x":0,"y":0.12098536225957167},{"x":0.1515151515151515,"y":0.13013306915798126},{"x":0.303030303030303,"y":0.1391714040558564},{"x":0.4545454545454545,"y":0.14798572940993074},{"x":0.6060606060606061,"y":0.15645777823895984},{"x":0.7575757575757576,"y":0.1644682126638791},{"x":0.9090909090909091,"y":0.17189936779597245},{"x":1.060606060606061,"y":0.1786380949957625},{"x":1.212121212121212,"y":0.1845786098098487},{"x":1.363636363636364,"y":0.18962524515457918},{"x":1.515151515151515,"y":0.19369500999336653},{"x":1.666666666666667,"y":0.19671985805096995},{"x":1.818181818181818,"y":0.19864857996587085},{"x":1.96969696969697,"y":0.1994482453783368},{"x":2.121212121212121,"y":0.1991051382113847},{"x":2.272727272727273,"y":0.19762514802646214},{"x":2.424242424242424,"y":0.1950336018506434},{"x":2.575757575757576,"y":0.19137454318543307},{"x":2.727272727272727,"y":0.1867094868769894},{"x":2.878787878787879,"y":0.18111569903330255},{"x":3.03030303030303,"y":0.1746840691863272},{"x":3.181818181818182,"y":0.16751665654118497},{"x":3.333333333333333,"y":0.1597240027611761},{"x":3.484848484848485,"y":0.15142230988016647},{"x":3.636363636363636,"y":0.14273058344920247},{"x":3.787878787878788,"y":0.13376783801223838},{"x":3.939393939393939,"y":0.12465045481480101},{"x":4.090909090909091,"y":0.11548977084320669},{"x":4.242424242424242,"y":0.1063899646054096},{"x":4.393939393939394,"y":0.09744628834948768},{"x":4.545454545454545,"y":0.08874367958231379},{"x":4.696969696969697,"y":0.08035576770889953},{"x":4.848484848484848,"y":0.07234427521687625},{"x":5,"y":0.06475879783294586},{"x":5.151515151515152,"y":0.05763693509221288},{"x":5.303030303030303,"y":0.051004732236744024},{"x":5.454545454545455,"y":0.04487738657066214},{"x":5.606060606060606,"y":0.03926016644494569},{"x":5.757575757575758,"y":0.03414948886235444},{"x":5.909090909090909,"y":0.02953410207628975},{"x":6.060606060606061,"y":0.025396322187902023},{"x":6.212121212121212,"y":0.02171327722262099},{"x":6.363636363636364,"y":0.0184581180414643},{"x":6.515151515151515,"y":0.015601162248989789},{"x":6.666666666666667,"y":0.013110944546854752},{"x":6.818181818181818,"y":0.01095515433554187},{"x":6.96969696969697,"y":0.009101448429106639},{"x":7.121212121212121,"y":0.007518133229683001},{"x":7.272727272727273,"y":0.006174716395760555},{"x":7.424242424242424,"y":0.005042332792223683},{"x":7.575757575757576,"y":0.004094053263393624},{"x":7.727272727272727,"y":0.0033050875186944255},{"x":7.878787878787879,"y":0.002652894212643802},{"x":8.03030303030303,"y":0.002117212225924384},{"x":8.181818181818182,"y":0.0016800273299080965},{"x":8.333333333333332,"y":0.0013254879772150497},{"x":8.484848484848484,"y":0.0010397830454919879},{"x":8.636363636363637,"y":8.10993107200834E-4},{"x":8.787878787878787,"y":6.289253312080865E-4},{"x":8.93939393939394,"y":4.849405535559764E-4},{"x":9.090909090909092,"y":3.7177947793890046E-4},{"x":9.242424242424242,"y":2.833934545377709E-4},{"x":9.393939393939394,"y":2.1478389305454535E-4},{"x":9.545454545454545,"y":1.618531280464772E-4},{"x":9.696969696969697,"y":1.212684920196218E-4},{"x":9.848484848484848,"y":9.034047084076489E-5},{"x":10,"y":6.691511288244271E-5}]},{"name":"bbbf2b30-92ba-468d-acea-f98fba072268","values":[{"x":-6.026991926961378,"y":0},{"x":-5.870436760312047,"y":6.387524739058335E-4},{"x":-5.713881593662716,"y":0.0},{"x":-5.557326427013385,"y":0.0},{"x":-5.4007712603640545,"y":0.0},{"x":-5.244216093714724,"y":0.0},{"x":-5.087660927065393,"y":0.0},{"x":-4.931105760416062,"y":0.0},{"x":-4.774550593766731,"y":0.0019162574217175005},{"x":-4.617995427117401,"y":0.0},{"x":-4.46144026046807,"y":0.0019162574217175005},{"x":-4.304885093818739,"y":0.001277504947811667},{"x":-4.148329927169408,"y":0.0019162574217175005},{"x":-3.9917747605200775,"y":6.387524739058335E-4},{"x":-3.8352195938707467,"y":0.004471267317340834},{"x":-3.678664427221416,"y":0.0019162574217175005},{"x":-3.522109260572085,"y":0.001277504947811667},{"x":-3.3655540939227544,"y":0.003832514843435001},{"x":-3.2089989272734236,"y":0.005748772265152502},{"x":-3.052443760624093,"y":0.005748772265152502},{"x":-2.895888593974762,"y":0.008942534634681669},{"x":-2.7393334273254313,"y":0.010858792056399169},{"x":-2.5827782606761005,"y":0.012136297004210837},{"x":-2.4262230940267697,"y":0.01277504947811667},{"x":-2.269667927377439,"y":0.015330059373740004},{"x":-2.113112760728108,"y":0.020440079164986674},{"x":-1.9565575940787774,"y":0.02874386132576251},{"x":-1.8000024274294466,"y":0.030021366273574174},{"x":-1.6434472607801158,"y":0.03257637616919751},{"x":-1.486892094130785,"y":0.044712673173408345},{"x":-1.3303369274814543,"y":0.05748772265152502},{"x":-1.1737817608321235,"y":0.05940398007324252},{"x":-1.0172265941827927,"y":0.06834651470792419},{"x":-0.860671427533462,"y":0.07281778202526502},{"x":-0.7041162608841314,"y":0.07920530676432336},{"x":-0.5475610942348007,"y":0.07090152460354752},{"x":-0.39100592758547004,"y":0.08750908892509919},{"x":-0.23445076093613937,"y":0.10411665324665087},{"x":-0.0778955942868087,"y":0.11178168293352087},{"x":0.07865957236252197,"y":0.12647298983335503},{"x":0.23521473901185264,"y":0.13605427694194255},{"x":0.3917699056611833,"y":0.1354155244680367},{"x":0.548325072310514,"y":0.14819057394615337},{"x":0.7048802389598446,"y":0.14627431652443587},{"x":0.8614354056091753,"y":0.1577718610547409},{"x":1.017990572258506,"y":0.17118566300676338},{"x":1.1745457389078369,"y":0.18779322732831505},{"x":1.3311009055571676,"y":0.18396071248488005},{"x":1.4876560722064984,"y":0.20823330649330174},{"x":1.6442112388558292,"y":0.21206582133673674},{"x":1.80076640550516,"y":0.18523821743269173},{"x":1.9573215721544908,"y":0.18396071248488005},{"x":2.1138767388038215,"y":0.1941807520673734},{"x":2.2704319054531523,"y":0.2018457817542434},{"x":2.426987072102483,"y":0.21014956391501924},{"x":2.583542238751814,"y":0.1903482372239384},{"x":2.7400974054011447,"y":0.18332196001097423},{"x":2.8966525720504754,"y":0.1635206333198934},{"x":3.053207738699806,"y":0.15074558384177672},{"x":3.209762905349137,"y":0.16288188084598754},{"x":3.3663180719984678,"y":0.17246316795457506},{"x":3.5228732386477986,"y":0.15010683136787087},{"x":3.6794284052971293,"y":0.15393934621130587},{"x":3.83598357194646,"y":0.1373317818897542},{"x":3.992538738595791,"y":0.13988679178537755},{"x":4.149093905245121,"y":0.11305918788133254},{"x":4.305649071894452,"y":0.10220039582493336},{"x":4.462204238543783,"y":0.10667166314227419},{"x":4.618759405193114,"y":0.0932578611902517},{"x":4.775314571842444,"y":0.07409528697307668},{"x":4.931869738491775,"y":0.06706900976011251},{"x":5.088424905141106,"y":0.07154027707745335},{"x":5.244980071790437,"y":0.06898526718183003},{"x":5.4015352384397675,"y":0.044073920699502514},{"x":5.558090405089098,"y":0.042157663277785015},{"x":5.714645571738429,"y":0.042796415751690846},{"x":5.87120073838776,"y":0.02746635637795084},{"x":6.027755905037091,"y":0.035770138538726674},{"x":6.184311071686421,"y":0.01980132669108084},{"x":6.340866238335752,"y":0.020440079164986674},{"x":6.497421404985083,"y":0.01852382174326917},{"x":6.653976571634414,"y":0.017246316795457507},{"x":6.8105317382837445,"y":0.009581287108587503},{"x":6.967086904933075,"y":0.010220039582493337},{"x":7.123642071582406,"y":0.010858792056399169},{"x":7.280197238231737,"y":0.007665029686870002},{"x":7.436752404881068,"y":0.003832514843435001},{"x":7.593307571530398,"y":0.007026277212964169},{"x":7.749862738179729,"y":0.005748772265152502},{"x":7.90641790482906,"y":0.0031937623695291674},{"x":8.06297307147839,"y":0.003832514843435001},{"x":8.21952823812772,"y":0.0019162574217175005},{"x":8.37608340477705,"y":0.001277504947811667},{"x":8.53263857142638,"y":6.387524739058335E-4},{"x":8.68919373807571,"y":0.0},{"x":8.84574890472504,"y":0.0},{"x":9.00230407137437,"y":0.001277504947811667},{"x":9.1588592380237,"y":0.0019162574217175005},{"x":9.31541440467303,"y":0.0},{"x":9.47196957132236,"y":0.0},{"x":9.62852473797169,"y":6.387524739058335E-4},{"x":9.78507990462102,"y":0}]}],"marks":[{"type":"line","from":{"data":"d956205f-0197-4b28-a69b-51d094bfbc75"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"bbbf2b30-92ba-468d-acea-f98fba072268"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"d956205f-0197-4b28-a69b-51d094bfbc75\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"d956205f-0197-4b28-a69b-51d094bfbc75\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"d956205f-0197-4b28-a69b-51d094bfbc75\", :values ({:x -5, :y 4.3634134752288024E-4} {:x -160/33, :y 5.671970386513821E-4} {:x -155/33, :y 7.330760541955561E-4} {:x -50/11, :y 9.42044905076907E-4} {:x -145/33, :y 0.0012036540160990396} {:x -140/33, :y 0.0015291117517670808} {:x -45/11, :y 0.001931453582514972} {:x -130/33, :y 0.0024256984882430987} {:x -125/33, :y 0.0030289831142058456} {:x -40/11, :y 0.0037606626743546595} {:x -115/33, :y 0.004642366243399356} {:x -10/3, :y 0.0056979930118987235} {:x -35/11, :y 0.0069536354318799525} {:x -100/33, :y 0.008437415093311126} {:x -95/33, :y 0.010179217781743341} {:x -30/11, :y 0.01221031560013476} {:x -85/33, :y 0.014562866395343413} {:x -80/33, :y 0.01726928407836528} {:x -25/11, :y 0.02036147778541647} {:x -70/33, :y 0.023869963153426765} {:x -65/33, :y 0.02782285516898323} {:x -20/11, :y 0.032244758910466395} {:x -5/3, :y 0.03715558177949653} {:x -50/33, :y 0.04256929817839459} {:x -15/11, :y 0.04849270464169628} {:x -40/33, :y 0.05492420973253507} {:x -35/33, :y 0.06185270810597594} {:x -10/11, :y 0.06925659156197403} {:x -25/33, :y 0.07710295123647007} {:x -20/33, :y 0.08534702395452404} {:x -5/11, :y 0.09393193193992498} {:x -10/33, :y 0.10278875841821113} {:x -5/33, :y 0.11183699219670964} {:x 0N, :y 0.12098536225957167} {:x 5/33, :y 0.13013306915798126} {:x 10/33, :y 0.1391714040558564} {:x 5/11, :y 0.14798572940993074} {:x 20/33, :y 0.15645777823895984} {:x 25/33, :y 0.1644682126638791} {:x 10/11, :y 0.17189936779597245} {:x 35/33, :y 0.1786380949957625} {:x 40/33, :y 0.1845786098098487} {:x 15/11, :y 0.18962524515457918} {:x 50/33, :y 0.19369500999336653} {:x 5/3, :y 0.19671985805096995} {:x 20/11, :y 0.19864857996587085} {:x 65/33, :y 0.1994482453783368} {:x 70/33, :y 0.1991051382113847} {:x 25/11, :y 0.19762514802646214} {:x 80/33, :y 0.1950336018506434} {:x 85/33, :y 0.19137454318543307} {:x 30/11, :y 0.1867094868769894} {:x 95/33, :y 0.18111569903330255} {:x 100/33, :y 0.1746840691863272} {:x 35/11, :y 0.16751665654118497} {:x 10/3, :y 0.1597240027611761} {:x 115/33, :y 0.15142230988016647} {:x 40/11, :y 0.14273058344920247} {:x 125/33, :y 0.13376783801223838} {:x 130/33, :y 0.12465045481480101} {:x 45/11, :y 0.11548977084320669} {:x 140/33, :y 0.1063899646054096} {:x 145/33, :y 0.09744628834948768} {:x 50/11, :y 0.08874367958231379} {:x 155/33, :y 0.08035576770889953} {:x 160/33, :y 0.07234427521687625} {:x 5N, :y 0.06475879783294586} {:x 170/33, :y 0.05763693509221288} {:x 175/33, :y 0.051004732236744024} {:x 60/11, :y 0.04487738657066214} {:x 185/33, :y 0.03926016644494569} {:x 190/33, :y 0.03414948886235444} {:x 65/11, :y 0.02953410207628975} {:x 200/33, :y 0.025396322187902023} {:x 205/33, :y 0.02171327722262099} {:x 70/11, :y 0.0184581180414643} {:x 215/33, :y 0.015601162248989789} {:x 20/3, :y 0.013110944546854752} {:x 75/11, :y 0.01095515433554187} {:x 230/33, :y 0.009101448429106639} {:x 235/33, :y 0.007518133229683001} {:x 80/11, :y 0.006174716395760555} {:x 245/33, :y 0.005042332792223683} {:x 250/33, :y 0.004094053263393624} {:x 85/11, :y 0.0033050875186944255} {:x 260/33, :y 0.002652894212643802} {:x 265/33, :y 0.002117212225924384} {:x 90/11, :y 0.0016800273299080965} {:x 25/3, :y 0.0013254879772150497} {:x 280/33, :y 0.0010397830454919879} {:x 95/11, :y 8.10993107200834E-4} {:x 290/33, :y 6.289253312080865E-4} {:x 295/33, :y 4.849405535559764E-4} {:x 100/11, :y 3.7177947793890046E-4} {:x 305/33, :y 2.833934545377709E-4} {:x 310/33, :y 2.1478389305454535E-4} {:x 105/11, :y 1.618531280464772E-4} {:x 320/33, :y 1.212684920196218E-4} {:x 325/33, :y 9.034047084076489E-5} {:x 10N, :y 6.691511288244271E-5})} {:name \"bbbf2b30-92ba-468d-acea-f98fba072268\", :values ({:x -6.026991926961378, :y 0} {:x -5.870436760312047, :y 6.387524739058335E-4} {:x -5.713881593662716, :y 0.0} {:x -5.557326427013385, :y 0.0} {:x -5.4007712603640545, :y 0.0} {:x -5.244216093714724, :y 0.0} {:x -5.087660927065393, :y 0.0} {:x -4.931105760416062, :y 0.0} {:x -4.774550593766731, :y 0.0019162574217175005} {:x -4.617995427117401, :y 0.0} {:x -4.46144026046807, :y 0.0019162574217175005} {:x -4.304885093818739, :y 0.001277504947811667} {:x -4.148329927169408, :y 0.0019162574217175005} {:x -3.9917747605200775, :y 6.387524739058335E-4} {:x -3.8352195938707467, :y 0.004471267317340834} {:x -3.678664427221416, :y 0.0019162574217175005} {:x -3.522109260572085, :y 0.001277504947811667} {:x -3.3655540939227544, :y 0.003832514843435001} {:x -3.2089989272734236, :y 0.005748772265152502} {:x -3.052443760624093, :y 0.005748772265152502} {:x -2.895888593974762, :y 0.008942534634681669} {:x -2.7393334273254313, :y 0.010858792056399169} {:x -2.5827782606761005, :y 0.012136297004210837} {:x -2.4262230940267697, :y 0.01277504947811667} {:x -2.269667927377439, :y 0.015330059373740004} {:x -2.113112760728108, :y 0.020440079164986674} {:x -1.9565575940787774, :y 0.02874386132576251} {:x -1.8000024274294466, :y 0.030021366273574174} {:x -1.6434472607801158, :y 0.03257637616919751} {:x -1.486892094130785, :y 0.044712673173408345} {:x -1.3303369274814543, :y 0.05748772265152502} {:x -1.1737817608321235, :y 0.05940398007324252} {:x -1.0172265941827927, :y 0.06834651470792419} {:x -0.860671427533462, :y 0.07281778202526502} {:x -0.7041162608841314, :y 0.07920530676432336} {:x -0.5475610942348007, :y 0.07090152460354752} {:x -0.39100592758547004, :y 0.08750908892509919} {:x -0.23445076093613937, :y 0.10411665324665087} {:x -0.0778955942868087, :y 0.11178168293352087} {:x 0.07865957236252197, :y 0.12647298983335503} {:x 0.23521473901185264, :y 0.13605427694194255} {:x 0.3917699056611833, :y 0.1354155244680367} {:x 0.548325072310514, :y 0.14819057394615337} {:x 0.7048802389598446, :y 0.14627431652443587} {:x 0.8614354056091753, :y 0.1577718610547409} {:x 1.017990572258506, :y 0.17118566300676338} {:x 1.1745457389078369, :y 0.18779322732831505} {:x 1.3311009055571676, :y 0.18396071248488005} {:x 1.4876560722064984, :y 0.20823330649330174} {:x 1.6442112388558292, :y 0.21206582133673674} {:x 1.80076640550516, :y 0.18523821743269173} {:x 1.9573215721544908, :y 0.18396071248488005} {:x 2.1138767388038215, :y 0.1941807520673734} {:x 2.2704319054531523, :y 0.2018457817542434} {:x 2.426987072102483, :y 0.21014956391501924} {:x 2.583542238751814, :y 0.1903482372239384} {:x 2.7400974054011447, :y 0.18332196001097423} {:x 2.8966525720504754, :y 0.1635206333198934} {:x 3.053207738699806, :y 0.15074558384177672} {:x 3.209762905349137, :y 0.16288188084598754} {:x 3.3663180719984678, :y 0.17246316795457506} {:x 3.5228732386477986, :y 0.15010683136787087} {:x 3.6794284052971293, :y 0.15393934621130587} {:x 3.83598357194646, :y 0.1373317818897542} {:x 3.992538738595791, :y 0.13988679178537755} {:x 4.149093905245121, :y 0.11305918788133254} {:x 4.305649071894452, :y 0.10220039582493336} {:x 4.462204238543783, :y 0.10667166314227419} {:x 4.618759405193114, :y 0.0932578611902517} {:x 4.775314571842444, :y 0.07409528697307668} {:x 4.931869738491775, :y 0.06706900976011251} {:x 5.088424905141106, :y 0.07154027707745335} {:x 5.244980071790437, :y 0.06898526718183003} {:x 5.4015352384397675, :y 0.044073920699502514} {:x 5.558090405089098, :y 0.042157663277785015} {:x 5.714645571738429, :y 0.042796415751690846} {:x 5.87120073838776, :y 0.02746635637795084} {:x 6.027755905037091, :y 0.035770138538726674} {:x 6.184311071686421, :y 0.01980132669108084} {:x 6.340866238335752, :y 0.020440079164986674} {:x 6.497421404985083, :y 0.01852382174326917} {:x 6.653976571634414, :y 0.017246316795457507} {:x 6.8105317382837445, :y 0.009581287108587503} {:x 6.967086904933075, :y 0.010220039582493337} {:x 7.123642071582406, :y 0.010858792056399169} {:x 7.280197238231737, :y 0.007665029686870002} {:x 7.436752404881068, :y 0.003832514843435001} {:x 7.593307571530398, :y 0.007026277212964169} {:x 7.749862738179729, :y 0.005748772265152502} {:x 7.90641790482906, :y 0.0031937623695291674} {:x 8.06297307147839, :y 0.003832514843435001} {:x 8.21952823812772, :y 0.0019162574217175005} {:x 8.37608340477705, :y 0.001277504947811667} {:x 8.53263857142638, :y 6.387524739058335E-4} {:x 8.68919373807571, :y 0.0} {:x 8.84574890472504, :y 0.0} {:x 9.00230407137437, :y 0.001277504947811667} {:x 9.1588592380237, :y 0.0019162574217175005} {:x 9.31541440467303, :y 0.0} {:x 9.47196957132236, :y 0.0} {:x 9.62852473797169, :y 6.387524739058335E-4} {:x 9.78507990462102, :y 0})}), :marks ({:type \"line\", :from {:data \"d956205f-0197-4b28-a69b-51d094bfbc75\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"bbbf2b30-92ba-468d-acea-f98fba072268\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; What is interesting, however, is that one can't immediately deduce, even in this very simple example, that the return value from the `marsaglia-normal` procedure is "scorable" in the sense that it can be "observed" in Anglican. 
;;; 
;;; In order to define an observable distribution in Anglican one must make these procedures scorable which means, for now, manually deriving and providing a log-pdf/pmf calculator.  
;; **

;; @@
(defdist my-normal
  "univariate normal with parameters mean and _variance_"
  [m v] []
    (sample* [this] (marsaglia-normal m v))
    (observe* [this value] (normal-lnpdf value m (sqrt v))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#multifn[print-method 0x51f4f763]</span>","value":"#multifn[print-method 0x51f4f763]"}
;; <=

;; **
;;; This can now be included in any Anglican program and used as a distribution - that is, it can be sampled from and observed upon.
;;; 
;;; Alternatively, we can also include the sampling procedure directly by defm'ing it, which produces a CPS version that can be used directly within Anglican.
;; **

;; @@
(defm marsaglia-normal-cps [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal-cps mean var))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal-cps</span>","value":"#'marsaglia/marsaglia-normal-cps"}
;; <=

;; **
;;; What is interesting about this is that it exposes the internal random state of the `marsaglia-normal` to the inference engine.  This may or may not be a good idea depending on a number of issues.
;;; 
;;; Here is the Gaussian unknown mean example from the Anglican paper. With the internal uniform continuous draws exposed to inference.
;;; 
;;; 
;; **

;; @@
(defquery unknown-mean-internals-exposed [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)]
      
          (observe (normal mu sigma) 9)
          (observe (normal mu sigma) 8)

          mu))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-internals-exposed</span>","value":"#'marsaglia/unknown-mean-internals-exposed"}
;; <=

;; **
;;; And here is the same but with the internals hidden from inference.
;; **

;; @@
  (def data [9 8])
  (with-primitive-procedures [my-normal] 
    (defquery unknown-mean-internals-hidden [d] 
      (let [sigma (sqrt 2)
            mu (sample (my-normal 1 5))
            obsdist (my-normal mu sigma)]
              (map (fn [d] (observe obsdist d)) data)
              mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-internals-hidden</span>","value":"#'marsaglia/unknown-mean-internals-hidden"}
;; <=

;; **
;;; |And here are the results.  (green: internals exposed, blue: internals hidden)
;; **

;; @@
(plot/compose  
  (plot/list-plot 
     (->> (linspace 3 11 100)
          (map #(into []  
                      [% (exp (observe* (my-normal 7.25 0.913) %))]))
          (into [])) :joined true)
  
     (->> (doquery :rmh unknown-mean-internals-exposed nil)
        (map :result)
        (take 20000)
        (#(plot/histogram % :normalize :probability-density :bins 100 :color "#5A0")))
     (->> (doquery :rmh unknown-mean-internals-hidden nil)
        (map :result)
        (take 20000)
        (#(plot/histogram % :normalize :probability-density :bins 100 :color "#05A"))))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"9c1148be-70ac-45d2-9de9-77ff83b90dcc","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"9c1148be-70ac-45d2-9de9-77ff83b90dcc","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"data":[{"name":"9c1148be-70ac-45d2-9de9-77ff83b90dcc","values":[{"x":3,"y":2.1120447273365065E-5},{"x":3.080808080808081,"y":3.06559212148127E-5},{"x":3.161616161616162,"y":4.417936572025371E-5},{"x":3.242424242424242,"y":6.321475027946064E-5},{"x":3.323232323232323,"y":8.980721358627321E-5},{"x":3.404040404040404,"y":1.2667702696868852E-4},{"x":3.484848484848485,"y":1.7741010279001163E-4},{"x":3.565656565656566,"y":2.4669064351566804E-4},{"x":3.646464646464646,"y":3.4058134267691864E-4},{"x":3.727272727272727,"y":4.6685592368091655E-4},{"x":3.808080808080808,"y":6.353876060507161E-4},{"x":3.888888888888889,"y":8.585951870717406E-4},{"x":3.96969696969697,"y":0.0011519456927384973},{"x":4.050505050505051,"y":0.0015345088793365367},{"x":4.131313131313131,"y":0.0020295541887882574},{"x":4.212121212121212,"y":0.0026651750689040605},{"x":4.292929292929293,"y":0.0034749189364212587},{"x":4.373737373737374,"y":0.004498393660516071},{"x":4.454545454545455,"y":0.0057818135718571565},{"x":4.535353535353535,"y":0.007378440084589371},{"x":4.616161616161616,"y":0.009348864619840636},{"x":4.696969696969697,"y":0.0117610753316202},{"x":4.777777777777778,"y":0.014690244956493105},{"x":4.858585858585859,"y":0.0182181757991257},{"x":4.939393939393939,"y":0.022432340295672155},{"x":5.02020202020202,"y":0.02742446256771582},{"x":5.101010101010101,"y":0.03328859853798022},{"x":5.181818181818182,"y":0.04011868992212774},{"x":5.262626262626263,"y":0.048005590790316216},{"x":5.343434343434343,"y":0.05703359402903087},{"x":5.424242424242424,"y":0.06727651805450008},{"x":5.505050505050505,"y":0.07879345013310377},{"x":5.585858585858586,"y":0.09162427973393426},{"x":5.666666666666667,"y":0.10578519109943506},{"x":5.747474747474747,"y":0.12126431595435049},{"x":5.828282828282828,"y":0.13801777208782148},{"x":5.909090909090909,"y":0.15596632858219608},{"x":5.98989898989899,"y":0.17499294115176633},{"x":6.070707070707071,"y":0.19494138936441785},{"x":6.151515151515152,"y":0.21561622021095458},{"x":6.232323232323232,"y":0.23678415932986338},{"x":6.313131313131313,"y":0.2581770931191938},{"x":6.393939393939394,"y":0.2794966541309653},{"x":6.474747474747475,"y":0.30042036190202076},{"x":6.555555555555556,"y":0.3206091861357449},{"x":6.636363636363636,"y":0.33971631411889075},{"x":6.717171717171717,"y":0.3573968250962097},{"x":6.797979797979798,"y":0.3733179067251942},{"x":6.878787878787879,"y":0.3871691979633977},{"x":6.95959595959596,"y":0.39867281319467224},{"x":7.04040404040404,"y":0.40759259718863483},{"x":7.121212121212121,"y":0.41374218111796457},{"x":7.202020202020202,"y":0.4169914560403278},{"x":7.282828282828283,"y":0.4172711498467348},{"x":7.363636363636364,"y":0.41457528280557543},{"x":7.444444444444444,"y":0.40896138012988537},{"x":7.525252525252525,"y":0.4005484310140701},{"x":7.606060606060606,"y":0.38951269527709476},{"x":7.686868686868687,"y":0.37608156401155074},{"x":7.767676767676768,"y":0.3605257728697965},{"x":7.848484848484848,"y":0.34315034022035634},{"x":7.929292929292929,"y":0.3242846531977055},{"x":8.01010101010101,"y":0.3042721501679745},{"x":8.090909090909092,"y":0.2834600477039632},{"x":8.171717171717171,"y":0.26218953498707503},{"x":8.252525252525253,"y":0.24078681146226066},{"x":8.333333333333332,"y":0.21955527874642172},{"x":8.414141414141413,"y":0.1987691203696934},{"x":8.494949494949495,"y":0.17866841856110108},{"x":8.575757575757576,"y":0.15945587167427858},{"x":8.656565656565657,"y":0.14129509430642737},{"x":8.737373737373737,"y":0.12431040927402966},{"x":8.818181818181818,"y":0.10858797993860228},{"x":8.8989898989899,"y":0.09417808531393819},{"x":8.97979797979798,"y":0.08109831009064292},{"x":9.06060606060606,"y":0.06933740716175898},{"x":9.141414141414142,"y":0.05885959036074949},{"x":9.222222222222221,"y":0.0496090280296045},{"x":9.303030303030303,"y":0.04151433122899048},{"x":9.383838383838384,"y":0.03449286106164318},{"x":9.464646464646465,"y":0.028454714800882783},{"x":9.545454545454545,"y":0.023306287533554286},{"x":9.626262626262626,"y":0.01895334239159247},{"x":9.707070707070708,"y":0.015303556149270606},{"x":9.787878787878787,"y":0.012268536504242653},{"x":9.868686868686869,"y":0.009765331768676515},{"x":9.94949494949495,"y":0.007717472504644725},{"x":10.03030303030303,"y":0.00605559782246243},{"x":10.11111111111111,"y":0.004717726961051387},{"x":10.19191919191919,"y":0.0036492399930358544},{"x":10.27272727272727,"y":0.0028026308238106633},{"x":10.35353535353535,"y":0.0021370919457381755},{"x":10.43434343434343,"y":0.0016179845341215383},{"x":10.51515151515152,"y":0.0012162402435766117},{"x":10.5959595959596,"y":9.077331960161564E-4},{"x":10.67676767676768,"y":6.726527337103154E-4},{"x":10.75757575757576,"y":4.948999958018433E-4},{"x":10.83838383838384,"y":3.615245829159397E-4},{"x":10.91919191919192,"y":2.622116977162102E-4},{"x":11,"y":1.888252794544033E-4}]},{"name":"7c8e649b-cdd5-4114-adc5-1c0e642994ee","values":[{"x":1.4813642171680328,"y":0},{"x":1.566912404387357,"y":5.844659206139868E-4},{"x":1.6524605916066812,"y":0.0},{"x":1.7380087788260055,"y":5.844659206139868E-4},{"x":1.8235569660453297,"y":0.0},{"x":1.909105153264654,"y":0.0},{"x":1.9946533404839781,"y":0.0},{"x":2.080201527703302,"y":0.0},{"x":2.1657497149226264,"y":0.0},{"x":2.2512979021419506,"y":0.0},{"x":2.336846089361275,"y":0.0},{"x":2.422394276580599,"y":0.0},{"x":2.5079424637999232,"y":0.0},{"x":2.5934906510192475,"y":0.0},{"x":2.6790388382385717,"y":0.0},{"x":2.764587025457896,"y":0.0},{"x":2.85013521267722,"y":0.0},{"x":2.9356833998965444,"y":0.0},{"x":3.0212315871158686,"y":0.0},{"x":3.106779774335193,"y":0.0},{"x":3.192327961554517,"y":0.0},{"x":3.2778761487738413,"y":0.0},{"x":3.3634243359931655,"y":0.0},{"x":3.4489725232124897,"y":0.0},{"x":3.534520710431814,"y":0.0},{"x":3.620068897651138,"y":0.0},{"x":3.7056170848704624,"y":0.0},{"x":3.7911652720897866,"y":0.0},{"x":3.876713459309111,"y":0.0},{"x":3.962261646528435,"y":0.0},{"x":4.047809833747759,"y":0.0},{"x":4.133358020967083,"y":0.0},{"x":4.218906208186406,"y":0.0},{"x":4.30445439540573,"y":0.009351454729823789},{"x":4.390002582625054,"y":0.0},{"x":4.475550769844378,"y":0.002337863682455947},{"x":4.5610989570637015,"y":0.0},{"x":4.646647144283025,"y":5.844659206139868E-4},{"x":4.732195331502349,"y":0.0},{"x":4.817743518721673,"y":0.0011689318412279736},{"x":4.903291705940997,"y":0.050848535093416844},{"x":4.98883989316032,"y":0.013442716174121695},{"x":5.074388080379644,"y":0.03682135299868117},{"x":5.159936267598968,"y":0.03448348931622522},{"x":5.245484454818292,"y":0.06429125126753854},{"x":5.3310326420376155,"y":0.07013591047367841},{"x":5.416580829256939,"y":0.07481163783859031},{"x":5.502129016476263,"y":0.09760580874253579},{"x":5.587677203695587,"y":0.16014366224823237},{"x":5.673225390914911,"y":0.10871066123420153},{"x":5.758773578134234,"y":0.10345046794867566},{"x":5.844321765353558,"y":0.23027957272191077},{"x":5.929869952572882,"y":0.23553976600743665},{"x":6.015418139792206,"y":0.28463490333901154},{"x":6.1009663270115295,"y":0.19988734484998347},{"x":6.186514514230853,"y":0.22852617496006883},{"x":6.272062701450177,"y":0.24021549337234854},{"x":6.357610888669501,"y":0.2600873346732241},{"x":6.443159075888825,"y":0.23553976600743665},{"x":6.528707263108148,"y":0.5529047609008315},{"x":6.614255450327472,"y":0.3799028483990914},{"x":6.699803637546796,"y":0.29398635806883533},{"x":6.78535182476612,"y":0.3237941200201487},{"x":6.8709000119854435,"y":0.44770089519031386},{"x":6.956448199204767,"y":0.33197664290874446},{"x":7.041996386424091,"y":0.4710795320148733},{"x":7.127544573643415,"y":0.4062038148267208},{"x":7.213092760862739,"y":0.5377086469648678},{"x":7.298640948082062,"y":0.40912614442979073},{"x":7.384189135301386,"y":0.3746426551135655},{"x":7.46973732252071,"y":0.44477856558724393},{"x":7.555285509740034,"y":0.32905431330567453},{"x":7.6408336969593575,"y":0.24547568665787442},{"x":7.726381884178681,"y":0.2916484943863794},{"x":7.811930071398005,"y":0.26710092572059196},{"x":7.897478258617329,"y":0.2869727670214675},{"x":7.983026445836653,"y":0.24956694810217234},{"x":8.068574633055977,"y":0.31502713121093884},{"x":8.154122820275301,"y":0.23612423192805065},{"x":8.239671007494625,"y":0.264763062038136},{"x":8.325219194713949,"y":0.22677277719822686},{"x":8.410767381933272,"y":0.20105627669121143},{"x":8.496315569152596,"y":0.09351454729823788},{"x":8.58186375637192,"y":0.20164074261182544},{"x":8.667411943591244,"y":0.23437083416620869},{"x":8.752960130810568,"y":0.15429900304209251},{"x":8.838508318029891,"y":0.004091261444297907},{"x":8.924056505249215,"y":0.03857475076052313},{"x":9.009604692468539,"y":0.039743682601751096},{"x":9.095152879687863,"y":0.05610872837894273},{"x":9.180701066907186,"y":0.015196113935963656},{"x":9.26624925412651,"y":0.035067955236839206},{"x":9.351797441345834,"y":0.09351454729823788},{"x":9.437345628565158,"y":0.016949511697805616},{"x":9.522893815784482,"y":0.01578057985657764},{"x":9.608442003003805,"y":0.01811844353903359},{"x":9.69399019022313,"y":0.011104852491665748},{"x":9.779538377442453,"y":5.844659206139868E-4},{"x":9.865086564661777,"y":0.0011689318412279736},{"x":9.9506347518811,"y":5.844659206139868E-4},{"x":10.036182939100424,"y":0.002922329603069934},{"x":10.121731126319748,"y":0.024547568665787445},{"x":10.207279313539072,"y":0}]},{"name":"fec3ca28-bcff-4ba7-ad65-c583e0b664e8","values":[{"x":4.4502615918914135,"y":0},{"x":4.5009640551642045,"y":0.005916872290522297},{"x":4.5516665184369955,"y":0.0},{"x":4.602368981709787,"y":0.0},{"x":4.653071444982578,"y":0.0},{"x":4.703773908255369,"y":0.0},{"x":4.75447637152816,"y":9.861453817537162E-4},{"x":4.805178834800951,"y":0.0},{"x":4.855881298073742,"y":0.0},{"x":4.906583761346533,"y":0.0},{"x":4.957286224619324,"y":0.0},{"x":5.007988687892115,"y":0.0},{"x":5.058691151164906,"y":0.0},{"x":5.109393614437697,"y":0.0},{"x":5.160096077710488,"y":0.0},{"x":5.210798540983279,"y":0.0},{"x":5.26150100425607,"y":0.0069030176722760135},{"x":5.312203467528861,"y":0.0},{"x":5.362905930801652,"y":0.0},{"x":5.413608394074443,"y":0.0},{"x":5.464310857347234,"y":0.0},{"x":5.515013320620025,"y":0.05818257752346926},{"x":5.565715783892816,"y":0.09466995664835676},{"x":5.6164182471656074,"y":0.0},{"x":5.6671207104383985,"y":0.06607174057749898},{"x":5.7178231737111895,"y":0.014792180726305743},{"x":5.768525636983981,"y":0.0},{"x":5.819228100256772,"y":0.0},{"x":5.869930563529563,"y":0.0},{"x":5.920633026802354,"y":0.0},{"x":5.971335490075145,"y":0.0},{"x":6.022037953347936,"y":0.0},{"x":6.072740416620727,"y":0.19624293096898954},{"x":6.123442879893518,"y":0.0},{"x":6.174145343166309,"y":0.0},{"x":6.2248478064391,"y":0.09072537512134189},{"x":6.275550269711891,"y":0.12228202733746081},{"x":6.326252732984682,"y":0.0},{"x":6.376955196257473,"y":0.16074169722585574},{"x":6.427657659530264,"y":0.0},{"x":6.478360122803055,"y":0.0},{"x":6.529062586075846,"y":0.212021257077049},{"x":6.579765049348637,"y":0.2475224908201828},{"x":6.630467512621428,"y":0.0},{"x":6.681169975894219,"y":0.027612070689104054},{"x":6.73187243916701,"y":0.11932359119219967},{"x":6.782574902439801,"y":1.3786312436916954},{"x":6.8332773657125925,"y":0.2721761253640257},{"x":6.8839798289853835,"y":0.3382478659415247},{"x":6.934682292258175,"y":0.2889405968538389},{"x":6.985384755530966,"y":0.32542797597872636},{"x":7.036087218803757,"y":0.3155665221611892},{"x":7.086789682076548,"y":0.2307580193303696},{"x":7.137492145349339,"y":0.04930726908768581},{"x":7.18819460862213,"y":0.2070905301682804},{"x":7.238897071894921,"y":0.569992030653648},{"x":7.289599535167712,"y":0.04043196065190237},{"x":7.340301998440503,"y":0.17750616871566893},{"x":7.391004461713294,"y":0.54928297763682},{"x":7.441706924986085,"y":1.1389979159255423},{"x":7.492409388258876,"y":1.4959825441203876},{"x":7.543111851531667,"y":2.0186395964498574},{"x":7.593814314804458,"y":0.5532275591638348},{"x":7.644516778077249,"y":0.3806521173569345},{"x":7.69521924135004,"y":0.5325185061470068},{"x":7.745921704622831,"y":1.5334560686270289},{"x":7.796624167895622,"y":1.2100003834118098},{"x":7.847326631168413,"y":0.6035209736332744},{"x":7.898029094441204,"y":0.757359653186854},{"x":7.948731557713995,"y":0.4654606201877541},{"x":7.9994340209867865,"y":0.7997639046022639},{"x":8.050136484259577,"y":0.2928851783808537},{"x":8.100838947532367,"y":0.2001875124960044},{"x":8.151541410805157,"y":0.19821522173249698},{"x":8.202243874077947,"y":0.05621028675996183},{"x":8.252946337350737,"y":0.0},{"x":8.303648800623527,"y":0.0},{"x":8.354351263896318,"y":0.35895691895835274},{"x":8.405053727169108,"y":0.0},{"x":8.455756190441898,"y":0.18638147715145237},{"x":8.506458653714688,"y":0.0},{"x":8.557161116987478,"y":0.0},{"x":8.607863580260268,"y":0.0},{"x":8.658566043533058,"y":0.0},{"x":8.709268506805849,"y":0.0},{"x":8.759970970078639,"y":0.1745477325704078},{"x":8.810673433351429,"y":0.0},{"x":8.861375896624219,"y":0.0},{"x":8.91207835989701,"y":0.0},{"x":8.9627808231698,"y":0.0},{"x":9.01348328644259,"y":0.0},{"x":9.06418574971538,"y":0.04930726908768581},{"x":9.11488821298817,"y":0.0},{"x":9.16559067626096,"y":0.0},{"x":9.21629313953375,"y":0.0},{"x":9.26699560280654,"y":0.0},{"x":9.31769806607933,"y":0.4053057519007774},{"x":9.36840052935212,"y":0.0},{"x":9.41910299262491,"y":0.0},{"x":9.469805455897701,"y":0.0},{"x":9.520507919170491,"y":0.14397722573604257},{"x":9.571210382443281,"y":0}]}],"marks":[{"type":"line","from":{"data":"9c1148be-70ac-45d2-9de9-77ff83b90dcc"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"7c8e649b-cdd5-4114-adc5-1c0e642994ee"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"#5A0"},"fillOpacity":{"value":0.4},"stroke":{"value":"#5A0"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"fec3ca28-bcff-4ba7-ad65-c583e0b664e8"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"#05A"},"fillOpacity":{"value":0.4},"stroke":{"value":"#05A"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"9c1148be-70ac-45d2-9de9-77ff83b90dcc\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"9c1148be-70ac-45d2-9de9-77ff83b90dcc\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"9c1148be-70ac-45d2-9de9-77ff83b90dcc\", :values ({:x 3, :y 2.1120447273365065E-5} {:x 305/99, :y 3.06559212148127E-5} {:x 313/99, :y 4.417936572025371E-5} {:x 107/33, :y 6.321475027946064E-5} {:x 329/99, :y 8.980721358627321E-5} {:x 337/99, :y 1.2667702696868852E-4} {:x 115/33, :y 1.7741010279001163E-4} {:x 353/99, :y 2.4669064351566804E-4} {:x 361/99, :y 3.4058134267691864E-4} {:x 41/11, :y 4.6685592368091655E-4} {:x 377/99, :y 6.353876060507161E-4} {:x 35/9, :y 8.585951870717406E-4} {:x 131/33, :y 0.0011519456927384973} {:x 401/99, :y 0.0015345088793365367} {:x 409/99, :y 0.0020295541887882574} {:x 139/33, :y 0.0026651750689040605} {:x 425/99, :y 0.0034749189364212587} {:x 433/99, :y 0.004498393660516071} {:x 49/11, :y 0.0057818135718571565} {:x 449/99, :y 0.007378440084589371} {:x 457/99, :y 0.009348864619840636} {:x 155/33, :y 0.0117610753316202} {:x 43/9, :y 0.014690244956493105} {:x 481/99, :y 0.0182181757991257} {:x 163/33, :y 0.022432340295672155} {:x 497/99, :y 0.02742446256771582} {:x 505/99, :y 0.03328859853798022} {:x 57/11, :y 0.04011868992212774} {:x 521/99, :y 0.048005590790316216} {:x 529/99, :y 0.05703359402903087} {:x 179/33, :y 0.06727651805450008} {:x 545/99, :y 0.07879345013310377} {:x 553/99, :y 0.09162427973393426} {:x 17/3, :y 0.10578519109943506} {:x 569/99, :y 0.12126431595435049} {:x 577/99, :y 0.13801777208782148} {:x 65/11, :y 0.15596632858219608} {:x 593/99, :y 0.17499294115176633} {:x 601/99, :y 0.19494138936441785} {:x 203/33, :y 0.21561622021095458} {:x 617/99, :y 0.23678415932986338} {:x 625/99, :y 0.2581770931191938} {:x 211/33, :y 0.2794966541309653} {:x 641/99, :y 0.30042036190202076} {:x 59/9, :y 0.3206091861357449} {:x 73/11, :y 0.33971631411889075} {:x 665/99, :y 0.3573968250962097} {:x 673/99, :y 0.3733179067251942} {:x 227/33, :y 0.3871691979633977} {:x 689/99, :y 0.39867281319467224} {:x 697/99, :y 0.40759259718863483} {:x 235/33, :y 0.41374218111796457} {:x 713/99, :y 0.4169914560403278} {:x 721/99, :y 0.4172711498467348} {:x 81/11, :y 0.41457528280557543} {:x 67/9, :y 0.40896138012988537} {:x 745/99, :y 0.4005484310140701} {:x 251/33, :y 0.38951269527709476} {:x 761/99, :y 0.37608156401155074} {:x 769/99, :y 0.3605257728697965} {:x 259/33, :y 0.34315034022035634} {:x 785/99, :y 0.3242846531977055} {:x 793/99, :y 0.3042721501679745} {:x 89/11, :y 0.2834600477039632} {:x 809/99, :y 0.26218953498707503} {:x 817/99, :y 0.24078681146226066} {:x 25/3, :y 0.21955527874642172} {:x 833/99, :y 0.1987691203696934} {:x 841/99, :y 0.17866841856110108} {:x 283/33, :y 0.15945587167427858} {:x 857/99, :y 0.14129509430642737} {:x 865/99, :y 0.12431040927402966} {:x 97/11, :y 0.10858797993860228} {:x 881/99, :y 0.09417808531393819} {:x 889/99, :y 0.08109831009064292} {:x 299/33, :y 0.06933740716175898} {:x 905/99, :y 0.05885959036074949} {:x 83/9, :y 0.0496090280296045} {:x 307/33, :y 0.04151433122899048} {:x 929/99, :y 0.03449286106164318} {:x 937/99, :y 0.028454714800882783} {:x 105/11, :y 0.023306287533554286} {:x 953/99, :y 0.01895334239159247} {:x 961/99, :y 0.015303556149270606} {:x 323/33, :y 0.012268536504242653} {:x 977/99, :y 0.009765331768676515} {:x 985/99, :y 0.007717472504644725} {:x 331/33, :y 0.00605559782246243} {:x 91/9, :y 0.004717726961051387} {:x 1009/99, :y 0.0036492399930358544} {:x 113/11, :y 0.0028026308238106633} {:x 1025/99, :y 0.0021370919457381755} {:x 1033/99, :y 0.0016179845341215383} {:x 347/33, :y 0.0012162402435766117} {:x 1049/99, :y 9.077331960161564E-4} {:x 1057/99, :y 6.726527337103154E-4} {:x 355/33, :y 4.948999958018433E-4} {:x 1073/99, :y 3.615245829159397E-4} {:x 1081/99, :y 2.622116977162102E-4} {:x 11N, :y 1.888252794544033E-4})} {:name \"7c8e649b-cdd5-4114-adc5-1c0e642994ee\", :values ({:x 1.4813642171680328, :y 0} {:x 1.566912404387357, :y 5.844659206139868E-4} {:x 1.6524605916066812, :y 0.0} {:x 1.7380087788260055, :y 5.844659206139868E-4} {:x 1.8235569660453297, :y 0.0} {:x 1.909105153264654, :y 0.0} {:x 1.9946533404839781, :y 0.0} {:x 2.080201527703302, :y 0.0} {:x 2.1657497149226264, :y 0.0} {:x 2.2512979021419506, :y 0.0} {:x 2.336846089361275, :y 0.0} {:x 2.422394276580599, :y 0.0} {:x 2.5079424637999232, :y 0.0} {:x 2.5934906510192475, :y 0.0} {:x 2.6790388382385717, :y 0.0} {:x 2.764587025457896, :y 0.0} {:x 2.85013521267722, :y 0.0} {:x 2.9356833998965444, :y 0.0} {:x 3.0212315871158686, :y 0.0} {:x 3.106779774335193, :y 0.0} {:x 3.192327961554517, :y 0.0} {:x 3.2778761487738413, :y 0.0} {:x 3.3634243359931655, :y 0.0} {:x 3.4489725232124897, :y 0.0} {:x 3.534520710431814, :y 0.0} {:x 3.620068897651138, :y 0.0} {:x 3.7056170848704624, :y 0.0} {:x 3.7911652720897866, :y 0.0} {:x 3.876713459309111, :y 0.0} {:x 3.962261646528435, :y 0.0} {:x 4.047809833747759, :y 0.0} {:x 4.133358020967083, :y 0.0} {:x 4.218906208186406, :y 0.0} {:x 4.30445439540573, :y 0.009351454729823789} {:x 4.390002582625054, :y 0.0} {:x 4.475550769844378, :y 0.002337863682455947} {:x 4.5610989570637015, :y 0.0} {:x 4.646647144283025, :y 5.844659206139868E-4} {:x 4.732195331502349, :y 0.0} {:x 4.817743518721673, :y 0.0011689318412279736} {:x 4.903291705940997, :y 0.050848535093416844} {:x 4.98883989316032, :y 0.013442716174121695} {:x 5.074388080379644, :y 0.03682135299868117} {:x 5.159936267598968, :y 0.03448348931622522} {:x 5.245484454818292, :y 0.06429125126753854} {:x 5.3310326420376155, :y 0.07013591047367841} {:x 5.416580829256939, :y 0.07481163783859031} {:x 5.502129016476263, :y 0.09760580874253579} {:x 5.587677203695587, :y 0.16014366224823237} {:x 5.673225390914911, :y 0.10871066123420153} {:x 5.758773578134234, :y 0.10345046794867566} {:x 5.844321765353558, :y 0.23027957272191077} {:x 5.929869952572882, :y 0.23553976600743665} {:x 6.015418139792206, :y 0.28463490333901154} {:x 6.1009663270115295, :y 0.19988734484998347} {:x 6.186514514230853, :y 0.22852617496006883} {:x 6.272062701450177, :y 0.24021549337234854} {:x 6.357610888669501, :y 0.2600873346732241} {:x 6.443159075888825, :y 0.23553976600743665} {:x 6.528707263108148, :y 0.5529047609008315} {:x 6.614255450327472, :y 0.3799028483990914} {:x 6.699803637546796, :y 0.29398635806883533} {:x 6.78535182476612, :y 0.3237941200201487} {:x 6.8709000119854435, :y 0.44770089519031386} {:x 6.956448199204767, :y 0.33197664290874446} {:x 7.041996386424091, :y 0.4710795320148733} {:x 7.127544573643415, :y 0.4062038148267208} {:x 7.213092760862739, :y 0.5377086469648678} {:x 7.298640948082062, :y 0.40912614442979073} {:x 7.384189135301386, :y 0.3746426551135655} {:x 7.46973732252071, :y 0.44477856558724393} {:x 7.555285509740034, :y 0.32905431330567453} {:x 7.6408336969593575, :y 0.24547568665787442} {:x 7.726381884178681, :y 0.2916484943863794} {:x 7.811930071398005, :y 0.26710092572059196} {:x 7.897478258617329, :y 0.2869727670214675} {:x 7.983026445836653, :y 0.24956694810217234} {:x 8.068574633055977, :y 0.31502713121093884} {:x 8.154122820275301, :y 0.23612423192805065} {:x 8.239671007494625, :y 0.264763062038136} {:x 8.325219194713949, :y 0.22677277719822686} {:x 8.410767381933272, :y 0.20105627669121143} {:x 8.496315569152596, :y 0.09351454729823788} {:x 8.58186375637192, :y 0.20164074261182544} {:x 8.667411943591244, :y 0.23437083416620869} {:x 8.752960130810568, :y 0.15429900304209251} {:x 8.838508318029891, :y 0.004091261444297907} {:x 8.924056505249215, :y 0.03857475076052313} {:x 9.009604692468539, :y 0.039743682601751096} {:x 9.095152879687863, :y 0.05610872837894273} {:x 9.180701066907186, :y 0.015196113935963656} {:x 9.26624925412651, :y 0.035067955236839206} {:x 9.351797441345834, :y 0.09351454729823788} {:x 9.437345628565158, :y 0.016949511697805616} {:x 9.522893815784482, :y 0.01578057985657764} {:x 9.608442003003805, :y 0.01811844353903359} {:x 9.69399019022313, :y 0.011104852491665748} {:x 9.779538377442453, :y 5.844659206139868E-4} {:x 9.865086564661777, :y 0.0011689318412279736} {:x 9.9506347518811, :y 5.844659206139868E-4} {:x 10.036182939100424, :y 0.002922329603069934} {:x 10.121731126319748, :y 0.024547568665787445} {:x 10.207279313539072, :y 0})} {:name \"fec3ca28-bcff-4ba7-ad65-c583e0b664e8\", :values ({:x 4.4502615918914135, :y 0} {:x 4.5009640551642045, :y 0.005916872290522297} {:x 4.5516665184369955, :y 0.0} {:x 4.602368981709787, :y 0.0} {:x 4.653071444982578, :y 0.0} {:x 4.703773908255369, :y 0.0} {:x 4.75447637152816, :y 9.861453817537162E-4} {:x 4.805178834800951, :y 0.0} {:x 4.855881298073742, :y 0.0} {:x 4.906583761346533, :y 0.0} {:x 4.957286224619324, :y 0.0} {:x 5.007988687892115, :y 0.0} {:x 5.058691151164906, :y 0.0} {:x 5.109393614437697, :y 0.0} {:x 5.160096077710488, :y 0.0} {:x 5.210798540983279, :y 0.0} {:x 5.26150100425607, :y 0.0069030176722760135} {:x 5.312203467528861, :y 0.0} {:x 5.362905930801652, :y 0.0} {:x 5.413608394074443, :y 0.0} {:x 5.464310857347234, :y 0.0} {:x 5.515013320620025, :y 0.05818257752346926} {:x 5.565715783892816, :y 0.09466995664835676} {:x 5.6164182471656074, :y 0.0} {:x 5.6671207104383985, :y 0.06607174057749898} {:x 5.7178231737111895, :y 0.014792180726305743} {:x 5.768525636983981, :y 0.0} {:x 5.819228100256772, :y 0.0} {:x 5.869930563529563, :y 0.0} {:x 5.920633026802354, :y 0.0} {:x 5.971335490075145, :y 0.0} {:x 6.022037953347936, :y 0.0} {:x 6.072740416620727, :y 0.19624293096898954} {:x 6.123442879893518, :y 0.0} {:x 6.174145343166309, :y 0.0} {:x 6.2248478064391, :y 0.09072537512134189} {:x 6.275550269711891, :y 0.12228202733746081} {:x 6.326252732984682, :y 0.0} {:x 6.376955196257473, :y 0.16074169722585574} {:x 6.427657659530264, :y 0.0} {:x 6.478360122803055, :y 0.0} {:x 6.529062586075846, :y 0.212021257077049} {:x 6.579765049348637, :y 0.2475224908201828} {:x 6.630467512621428, :y 0.0} {:x 6.681169975894219, :y 0.027612070689104054} {:x 6.73187243916701, :y 0.11932359119219967} {:x 6.782574902439801, :y 1.3786312436916954} {:x 6.8332773657125925, :y 0.2721761253640257} {:x 6.8839798289853835, :y 0.3382478659415247} {:x 6.934682292258175, :y 0.2889405968538389} {:x 6.985384755530966, :y 0.32542797597872636} {:x 7.036087218803757, :y 0.3155665221611892} {:x 7.086789682076548, :y 0.2307580193303696} {:x 7.137492145349339, :y 0.04930726908768581} {:x 7.18819460862213, :y 0.2070905301682804} {:x 7.238897071894921, :y 0.569992030653648} {:x 7.289599535167712, :y 0.04043196065190237} {:x 7.340301998440503, :y 0.17750616871566893} {:x 7.391004461713294, :y 0.54928297763682} {:x 7.441706924986085, :y 1.1389979159255423} {:x 7.492409388258876, :y 1.4959825441203876} {:x 7.543111851531667, :y 2.0186395964498574} {:x 7.593814314804458, :y 0.5532275591638348} {:x 7.644516778077249, :y 0.3806521173569345} {:x 7.69521924135004, :y 0.5325185061470068} {:x 7.745921704622831, :y 1.5334560686270289} {:x 7.796624167895622, :y 1.2100003834118098} {:x 7.847326631168413, :y 0.6035209736332744} {:x 7.898029094441204, :y 0.757359653186854} {:x 7.948731557713995, :y 0.4654606201877541} {:x 7.9994340209867865, :y 0.7997639046022639} {:x 8.050136484259577, :y 0.2928851783808537} {:x 8.100838947532367, :y 0.2001875124960044} {:x 8.151541410805157, :y 0.19821522173249698} {:x 8.202243874077947, :y 0.05621028675996183} {:x 8.252946337350737, :y 0.0} {:x 8.303648800623527, :y 0.0} {:x 8.354351263896318, :y 0.35895691895835274} {:x 8.405053727169108, :y 0.0} {:x 8.455756190441898, :y 0.18638147715145237} {:x 8.506458653714688, :y 0.0} {:x 8.557161116987478, :y 0.0} {:x 8.607863580260268, :y 0.0} {:x 8.658566043533058, :y 0.0} {:x 8.709268506805849, :y 0.0} {:x 8.759970970078639, :y 0.1745477325704078} {:x 8.810673433351429, :y 0.0} {:x 8.861375896624219, :y 0.0} {:x 8.91207835989701, :y 0.0} {:x 8.9627808231698, :y 0.0} {:x 9.01348328644259, :y 0.0} {:x 9.06418574971538, :y 0.04930726908768581} {:x 9.11488821298817, :y 0.0} {:x 9.16559067626096, :y 0.0} {:x 9.21629313953375, :y 0.0} {:x 9.26699560280654, :y 0.0} {:x 9.31769806607933, :y 0.4053057519007774} {:x 9.36840052935212, :y 0.0} {:x 9.41910299262491, :y 0.0} {:x 9.469805455897701, :y 0.0} {:x 9.520507919170491, :y 0.14397722573604257} {:x 9.571210382443281, :y 0})}), :marks ({:type \"line\", :from {:data \"9c1148be-70ac-45d2-9de9-77ff83b90dcc\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"7c8e649b-cdd5-4114-adc5-1c0e642994ee\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"#5A0\"}, :fillOpacity {:value 0.4}, :stroke {:value \"#5A0\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"fec3ca28-bcff-4ba7-ad65-c583e0b664e8\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"#05A\"}, :fillOpacity {:value 0.4}, :stroke {:value \"#05A\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; Both of these diffferent queries generate empirical results close to the analytical posterior of $$\mathrm{Normal}(7.25,.913^2)$$
;; **

;; @@
  {:internals-exposed (->> (doquery :rmh unknown-mean-internals-exposed nil)
     (map :result)
     (take 20000)
     (#(/ (reduce + %) (count %))))}
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:internals-exposed</span>","value":":internals-exposed"},{"type":"html","content":"<span class='clj-double'>7.156862891648104</span>","value":"7.156862891648104"}],"value":"[:internals-exposed 7.156862891648104]"}],"value":"{:internals-exposed 7.156862891648104}"}
;; <=

;; @@
  {:internals-hidden (->> (doquery :rmh unknown-mean-internals-hidden nil)
     (map :result)
     (take 20000)
     (#(/ (reduce + %) (count %))))}
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:internals-hidden</span>","value":":internals-hidden"},{"type":"html","content":"<span class='clj-double'>7.462998212850242</span>","value":"7.462998212850242"}],"value":"[:internals-hidden 7.462998212850242]"}],"value":"{:internals-hidden 7.462998212850242}"}
;; <=

;; **
;;; Which implementation leads to a more efficient sampler? Why may this be in this case?
;; **
